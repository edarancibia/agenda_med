

<style>

	body {
		margin: 40px 10px;
		padding: 0;
		font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
		font-size: 14px;
	}

	#calendar {
		max-width: 900px;
		margin: 0 auto;
	}

</style>			
<!--</head>-->
<div th:include="header.html" th:remove="tag"></div>
<div th:include="nav.html" th:remove="tag"></div>
<body>
	<div class="container-fluid">
    
    <div style="margin-top:10px;" class="mainbox col-md-9 col-md-offset-2 col-sm-10 col-sm-offset-2">
      <div class="col-xs-9" id='calendar'></div>
    </div>
	</div>

<div class="modal fade" id="modalNew">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Nueva hora</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <label>Inicio</label>
                <input type="text" id="txtIni" name="txtIni" class="form-control" disabled>
                <label>Documento de indentidad</label>
                <div id="custom-search-input" >
                  <div class="input-group col-md-12">
                      <input type="text" class="form-control input-lg" placeholder="Buscar Doc. de Identidad" id="txtPaciente" name="txtPaciente" />
                      <span class="input-group-btn">
                          <button class="btn btn-info btn-lg" type="button" id="btnBuscaPaciente">
                              <i class="glyphicon glyphicon-search"></i>
                          </button>
                      </span>
                  </div>
              </div>
                
                <label>Paciente</label>
                <input type="text" name="txtNomPac" id="txtNomPac" class="form-control" readonly="true">
                <input type="hidden" id="txtFin" name="txtFin" class="form-control" disabled > 
                <label>Obs</label>
                <input type="text" name="txtobs" id="txtobs" class="form-control">
              </div>
              <div class="modal-footer">
                <button type="button" id="btnOK" class="btn btn-primary">Aceptar</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
              </div>
            </div>
          </div>
    </div>
    
    <div id="myModal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- dialog body -->
          <div class="modal-body">
            <input type="hidden" id="txtIdEvento" name="txtIdEvento">
            <input type="hidden" id="txtHiddenRut">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            ¿Qué desea hacer?
          </div>
          <!-- dialog buttons -->
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="btnComenzar">Comenzar atención</button>
            <button type="button" class="btn btn-primary" id="btnConfirmar">Confirmar</button>
            <button type="button" class="btn btn-primary" id="btnCancelEv">Cancelar</button>
            <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>


     <div id="modalPreguntaPac" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <!-- dialog body -->
          <div class="modal-body">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            Paciente no encontrado, ¿desea registrarlo?
          </div>
          <!-- dialog buttons -->
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="btnSi">Sí</button>
            <button type="button" class="btn btn-danger" data-dismiss="modal" id="btnNo">No</button>
          </div>
        </div>
      </div>
    </div>

    <!-- REGISTRA PACIENTE-->
    <div class="modal fade" id="modalNewPaciente">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Nuevo Paciente</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="txtRutPac" name="txtRutPac" class="form-control" disabled>
                <label>Nombre</label>
                <input type="text" class="form-control" name="txtNomPac2" id="txtNomPac2">
                <label>Apellido Paterno</label>
                <input type="text" name="txtApat" id="txtApat" class="form-control">
                <label>Apellido Materno</label>
                <input type="text" name="txtAmat" id="txtAmat" class="form-control">
                <label>Sexo</label>
                <select class="form-control" id="cboSexo2">
                  <option selected value="">Seleccione</option>
                  <option value="1">Hombre</option>
                  <option value="0">Mujer</option>
                </select>
                <label>Fecha nacimiento</label>
                <input type="date" id="txtFnac" class="form-control" required>
                <label>Teléfono</label>
                <input type="text" name="txtTel" id="txtTel" class="form-control">
                <label>Email</label>
                <input type="text" name="txtEmail2" id="txtEmail2" class="form-control">
              </div>
              <div class="modal-footer">
                <button type="button" id="btnGuardaPac" class="btn btn-primary">Aceptar</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
              </div>
            </div>
          </div>
    </div>
</div>
</body>

<script>

  $(document).ready(function() {
  
    var base_url = 'http://clinic-calendar.herokuapp.com/';
    var idCentro = 11;
    
    $('#calendar').fullCalendar({
  
          lang: 'es',
  
              monthNames: ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'],
              monthNamesShort: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
              dayNames: ['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'],
              dayNamesShort: ['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'],
  
              businessHours: {
                // days of week. an array of zero-based day of week integers (0=Sunday)
                dow: [ 1, 2, 3, 4,5], // Monday - Thursday
  
                start: '09:00', // a start time (10am in this example)
                end: '19:00', // an end time (6pm in this example)
              },

                editable: true,
                defaultView: 'agendaDay',
                height: 500,
                slotMinutes: 15,
  
                minTime: '09:00',
                maxTime: '19:00',
                selectable: true,
                allDaySlot: false,
                timeFormat: 'h:mm t{ - h:mm t} ',
                dragOpacity: "0.5",
                eventColor: '#378006',
                eventBorderColor: 'blue',
                displayEventTime: false,
                hiddenDays: [0],
                //defaultDate: moment().format("DD-MM-YYYY HH:mm"),
                defaultDate: Date(),
                editable: true,
                eventLimit: true, // allow "more" link when too many events
              
              select: function(start, end) {
                    $('#modalNew').modal('show');
                    $('#txtIni').val(moment(start).format('YYYY-MM-DD HH:mm:ss'));
                    $('#txtFin').val(moment(end).format('YYYY-MM-DD HH:mm:ss'));
                    //$.getScript('/events/new', function() {});
                  },

                  eventAfterRender: function (event, element, view) {
                      if (event.estado == 2) {
                          //event.color = "#FFB347"; //Em andamento
                          element.css('background-color', '#337DFF');
                      }   
                  },
                  
                  eventClick: function(event, jsEvent, view){
                      //showEventDetails(event);
                      //alert(event.title);
                      $("#idEvento").val(event.id);
                      $("#txtIdEvento").val(event.id);
                      $("#txtHiddenRut").val(event.rut);
                      $("#myModal").on("show", function() {    // wire up the OK button to dismiss the modal when shown  
                        $("#myModal a.btn").on("click", function(e) {
                              $("#myModal").modal('hide');     // dismiss the dialog
                          });
                      });
  
                      $("#myModal").on("hide", function() {    // remove the event listeners when the dialog is dismissed
                          $("#myModal a.btn").off("click");
                      });
                      
                      $("#myModal").on("hidden", function() {  // remove the actual elements from the DOM when fully hidden
                          $("#myModal").remove();
                      });
                      
                      $("#myModal").modal({                    // wire up the actual modal functionality and show the dialog
                        "backdrop"  : "static",
                        "keyboard"  : true,
                        "show"      : true                     // ensure the modal is shown immediately
                      });
                  }
      });
      
      getEvents();

      $('.fc-event-content, .fc-event-time, .fc-event-title').css('font-size', '12px');       

    /*$("#modalNew").on('show.bs.modal', function (event) {    // remove the event listeners when the dialog is dismissed
          $("#txtPaciente").val("");
          $("#txtNomPac").val("");
          $("#txtobs").val("");
    });*/

    function getEvents(){
        var idProfesional = $('#txtIdProf').val();
        $('#calendar').fullCalendar('removeEvents');
        $('#calendar').fullCalendar('addEventSource', 'https://clinic-calendar.herokuapp.com/alleventsByProf/'+idProfesional);
    }
    
    	//BUSCAR PACIENTE POR RUT AL PRESIONAR BOTON BUSCAR
    //$('#txtPaciente').keypress(function(e) {
		$('#btnBuscaPaciente').on('click',function(e){
			//var keycode = (e.keyCode ? e.keyCode : e.which);
			e.stopImmediatePropagation();
			//if (e.keyCode == 13) {
	
			  if($('#cboProfesional').val() < 1){
				alert('Seleccione un profesional');
			  }else{
				if($("#txtPaciente").val().length > 0){
				var rut = $('#txtPaciente').val();
				
				  $.ajax({
					type: 'get',
					url: 'https://clinic-calendar.herokuapp.com/paciente/'+rut,
					data: {dni: rut},
					success: function(data){
					  $('#txtNomPac').val(data.nombre+' '+data.a_pat+' '+data.a_mat);
					  $('#txtobs').focus();
	
					  if (data.rutnum > 1) {
						$('#btnOK').attr("disabled", false);
					  }
					},
					error:function(){
						$('#modalPreguntaPac').modal('show');
						$('#txtNomPac').val('');
						$('#txtRutPac').val($('#txtPaciente').val());
					  }
					});
				}
				else{
				  alert('Ingrese rut');
				  $('#txtNomPac').val('');
				}
		  }
			//}
		});
	
		//NUEVO PACIENTE
		$('#btnGuardaPac').click(function(e){
		  e.stopImmediatePropagation()
		  var nom = $('#txtNomPac2').val();
		  var apat = $('#txtApat').val();
		  var amat = $('#txtAmat').val();
		  var sexo = $('#cboSexo2').val(); 
		  var fnac = $('#txtFnac').val();
	
		  var formPac = {
			'dni'   : $('#txtRutPac').val(),
			'nombre'  : $('#txtNomPac2').val(),
			'a_pat'  : $('#txtApat').val(),
			'a_mat'  : $('#txtAmat').val(),
			'telefono'   : $('#txtTel').val(),
			'sexo'  : $('#cboSexo2').val(),
			'email' : $('#txtEmail2').val(),
			'fecha_nac'  : $('#txtFnac').val()
		  };
	
		  if(nom == "" || apat ==""){
			alert('Debe indicar nombre y apellido');
		  }else{
        if(sexo == ""){
          alert('Debe seleccionar sexo');
        } else {
          if(fnac == ""){
            alert('Ingrese fecha de nacimiento');
          }else{
            $.ajax({
              type: 'post',
              url: "https://clinic-calendar.herokuapp.com/addpaciente",
              contentType: "application/json; charset=utf-8",
              dataType: "json",
              data: JSON.stringify(formPac),
              success: function(){
              //toastr.success('Paciente guardado!');
              $('#modalNewPaciente').modal('hide');
              $('#txtNomPac').val(nom+' '+apat+' '+amat);
                $('#modalNewPaciente').modal('hide');
              $('#btnOK').attr("disabled", false);
              },
              error: function(){
              console.log('error al guardar paciente');
              }
            });
          }
        }
	
		  }
	
		});
	
		//limpia inputs cuando el modal se cierra
		$('#modalNew').on('hidden.bs.modal', function () {
			//$('#btnOK').attr("disabled", true);
			$('#txtPaciente').val('');
			$('#txtobs').val('');
			$('#txtNomPac').val('');
		});
	
		$('#btnSi').click(function(e){
		  e.stopImmediatePropagation()
		  $('#modalPreguntaPac').modal('hide');
		  $('#modalNewPaciente').modal('show');
		});
		
		//GUARDA EVENTO
		$('#btnOK').click(function(event) {
		  event.stopImmediatePropagation();
		  var pac = $('#txtPaciente').val();
	
		  if(pac == ""){
			  alert('Ingrese rut');
			  $('#txtPaciente').focus();
		  }else{
        var formData = {
          'title'       : $('#txtPaciente').val(),
          'start'       : $('#txtIni').val(),
          'end'	        : $('#txtFin').val(),
          'description' : $('#txtobs').val(),
          'fecha'       : Date.now(),
          'rut_num'     : $('#txtPaciente').val(),
          'rut_med'     : $('#cboProfesional').val(),
          'estado'      : 1
        };
			
        console.log(formData);
        $.ajax({
          type:'post',
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          url: "https://clinic-calendar.herokuapp.com/addevent",
          data: JSON.stringify(formData),
          success:function(data){
            console.log(data);
            $('#modalNew').modal('hide');
            $('#calendar').fullCalendar( 'refetchEvents' );
          },
        });
		  }
    });
    


	//CONFIRMAR CITA
	$('#btnConfirmar').on('click', function(e){
		e.stopImmediatePropagation();
		var idEvento = $("#txtIdEvento").val();
    var formData = {
      'estado' : 1
    };

		$.ajax({
			type: 'put',
      url: 'https://clinic-calendar.herokuapp.com/confirmar/'+ idEvento,
      contentType: "application/json; charset=utf-8",
      dataType: "json",
			data: JSON.stringify(formData),
			success: function(){
				$('#myModal').modal('hide');
        $('#calendar').fullCalendar( 'refetchEvents' );
      },
      error: function(){
        $('#myModal').modal('hide');
        $('#calendar').fullCalendar( 'refetchEvents' );
        console.log('error al confirmar cita');
      }
		});
  });
  
  //CANCELAR CITA
	$('#btnCancelEv').on('click', function(e){
		e.stopImmediatePropagation();
		var idEvento = $("#txtIdEvento").val();
    var formData = {
      'estado' : 0
    };

		$.ajax({
			type: 'put',
      url: 'https://clinic-calendar.herokuapp.com/cancelar/'+ idEvento,
      contentType: "application/json; charset=utf-8",
      dataType: "json",
			data: JSON.stringify(formData),
			success: function(){
				$('#myModal').modal('hide');
        $('#calendar').fullCalendar( 'refetchEvents' );
      },
      error: function(){
        $('#myModal').modal('hide');
        $('#calendar').fullCalendar( 'refetchEvents' );
        console.log('error al cancelar cita');
      }
		});
	});
	
    //REGISTRA USUARIO
    $('#btnOK_').click(function(event) {
        event.stopImmediatePropagation()
        var formData = {
          'nombre'      : $('#txt_reg_nombre').val(),
          'a_pat'       : $('#txt_reg_apat').val(),
          'a_mat'	      : $('#txt_reg_amat').val(),
          'email' 	  : $('#txt_reg_email').val(),
          'password'    : $('#txt_reg_pass').val()
        };
        
        console.log(formData);
        $.ajax({
            type:'post',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            url: "addevent",
            data: JSON.stringify(formData),
            success:function(data){
              console.log(data);
              $('#modalNew').modal('hide');
                window.location.reload();
            },
        });
    });
  });
  </script>
</html>